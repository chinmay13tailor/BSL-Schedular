<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Maintenance Scheduler</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css">
<style>
  :root{--ring:#e5e7eb;--bg:#fff;--text:#0f172a;--muted:#64748b;
        --blue:#3b82f6;--green:#22c55e;--amber:#f59e0b;--red:#ef4444;--slate:#111827;--gray:#6b7280}
  *{box-sizing:border-box}
  body{margin:0;background:#fff;color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}

  /* ======= LAYOUT (Header | Filters | Rail + Main + Side) ======= */
  .app{
    display:grid;
    grid-template-columns:64px 1fr 320px;     /* rail | main | right side */
    grid-template-rows:auto auto 1fr;         /* header | filters | content row */
    gap:16px;
    min-height:100vh;
    padding:16px;
  }

  header{
    grid-column:1 / -1;
    display:flex;gap:10px;align-items:center;
    border:1px solid var(--ring);border-radius:12px;background:#fff;padding:10px 12px
  }
  .spacer{flex:1}

  /* Filters (span main + side) */
  .filters{
    grid-column:2 / -1;
    display:flex;align-items:center;gap:10px;
    border:1px solid var(--ring);border-radius:12px;background:#fff;padding:10px 12px
  }
  .filters label{font-size:12px;color:#64748b;margin-right:4px}

  /* Left navigation rail */
  .rail{
    grid-column:1 / 2;
    grid-row:3 / 4;
    border:1px solid var(--ring);border-radius:12px;background:#fff;padding:8px;
    display:flex;flex-direction:column;align-items:center;gap:8px;
    position:sticky;top:16px;height:fit-content
  }
  .rail button{
    width:48px;height:48px;border-radius:12px;border:1px solid var(--ring);
    background:#fff;cursor:pointer;display:grid;place-items:center;font-size:18px
  }
  .rail button.active{border-color:#2563eb;box-shadow:0 0 0 2px rgba(37,99,235,.15)}
  .rail button:hover{background:#f8fafc}

  /* Main area (calendar/list container) */
  .card{border:1px solid var(--ring);border-radius:12px;background:#fff;overflow:hidden}
  #mainCard{grid-column:2 / 3;grid-row:3 / 4;min-height:560px}
  #calendar{min-height:560px}

  /* Right side details */
  .side{
    grid-column:3 / 4;grid-row:3 / 4;
    border:1px solid var(--ring);border-radius:12px;background:#fff;padding:14px;
    position:sticky;top:16px;height:fit-content
  }

  .empty{padding:12px;text-align:center;color:#64748b;background:#f8fafc;border-radius:10px}
  .h6{margin:0 0 10px;font-weight:900}
  .kpi{display:grid;grid-template-columns:120px 1fr;gap:8px;font-size:13px}
  .kpi span:first-child{color:#64748b}
  .side-actions{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}

  .btn,.input,textarea,select{border:1px solid var(--ring);border-radius:10px;background:#fff;padding:8px 10px}
  .btn{cursor:pointer;font-weight:800}
  .btn.primary{background:linear-gradient(#3b82f6,#2563eb);color:#fff;border:0}
  .btn.danger{border-color:var(--red);color:#dc2626}
  .btn.ghost{border-color:var(--ring);color:#0f172a}
  .btn:disabled{opacity:.6;cursor:not-allowed}

  .muted{color:#64748b}
  #loading{font-size:12px;color:#64748b;margin-left:8px}

  /* FullCalendar styles */
  .fc .fc-toolbar{padding:10px}
  .fc .fc-toolbar-title{font-size:16px;font-weight:800}
  .fc .fc-button{background:#fff;border:1px solid var(--ring);color:#0f172a;border-radius:10px;padding:6px 10px}
  .fc-theme-standard td,.fc-theme-standard th{border-color:var(--ring)}
  .fc-daygrid-day-number{color:#64748b}

  .event{border-radius:10px;border:0;padding:6px 8px;color:#fff;font-weight:700;box-shadow:0 1px 0 rgba(0,0,0,.08),0 8px 16px -12px rgba(0,0,0,.25)}
  .status-planned{background:var(--blue)}
  .status-inprogress{background:var(--amber)}
  .status-completed{background:var(--green)}
  .status-cancelled{background:var(--red)}
  .status-postponed{background:var(--gray)}

  .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid var(--ring);border-radius:999px;font-size:12px;background:#f8fafc}
  .chip button{border:0;background:transparent;cursor:pointer;font-weight:900;line-height:1}

  .fc-toolbar-chunk.legends{display:flex;gap:14px;align-items:center;margin-left:8px}
  .legend-box{display:inline-block;width:12px;height:12px;border-radius:3px;margin-right:6px}
  .legend-planned{background:var(--blue)}
  .legend-inprogress{background:var(--amber)}
  .legend-completed{background:var(--green)}
  .legend-cancelled{background:var(--red)}
  .legend-postponed{background:var(--gray)}

  /* ===== List tables ===== */
  .toolbar-row{display:flex;align-items:center;justify-content:space-between;padding:10px;border-bottom:1px solid var(--ring)}
  .table-wrap{overflow:auto;max-height:68vh}
  table{width:100%;border-collapse:collapse;font-size:13px}
  thead th{position:sticky;top:0;background:#f8fafc;z-index:1}
  th,td{border-bottom:1px solid var(--ring);padding:8px 10px;text-align:left;white-space:nowrap}
  tr:hover{background:#f9fafb;cursor:pointer}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;color:#fff;font-weight:700;font-size:11px}
  .badge.planned{background:var(--blue)} .badge.inprogress{background:var(--amber)}
  .badge.completed{background:var(--green)} .badge.cancelled{background:var(--red)} .badge.postponed{background:var(--gray)}
  .chip-note{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border:1px solid var(--ring);border-radius:999px;font-size:11px;background:#f8fafc;color:#475569}

  /* ===== Tips layout ===== */
  .tips-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;padding:12px}
  .tips-col{border:1px solid var(--ring);border-radius:12px;background:#fff;overflow:hidden;display:flex;flex-direction:column}

  .tips-col h4{margin:0;padding:10px 12px;font-weight:900;border-bottom:1px solid var(--ring);text-align:center}
  .tips-col h4 span{
    display:inline-block;margin-left:8px;padding:2px 8px;border-radius:999px;background:rgba(255,255,255,.22);color:inherit;font-weight:700;font-size:12px
  }
  #tipsPrev > h4{ background:var(--blue);  color:#fff;     border-bottom:0; }
  #tipsCorr > h4{ background:var(--amber); color:#111827;  border-bottom:0; }
  #tipsMiss > h4{ background:var(--red);   color:#fff;     border-bottom:0; }

  .tip-card{border-bottom:1px solid var(--ring);padding:12px}
  .tip-card:last-child{border-bottom:0}
  .tip-title{font-weight:900;margin-bottom:6px}
  .tip-body{color:#334155;white-space:pre-line}
  .tip-actions{margin-top:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .tip-empty{padding:14px;color:#64748b;text-align:center;background:#f8fafc;margin:10px;border-radius:10px}

  /* Tips loader */
  .tips-loading{display:flex;align-items:center;justify-content:center;padding:28px;color:#64748b}
  .tips-loading::after{
    content:""; width:16px;height:16px; margin-left:10px; border-radius:50%;
    border:2px solid #cbd5e1;border-top-color:#64748b; animation:spin 0.8s linear infinite;
  }
  @keyframes spin{to{transform:rotate(360deg)}}

  /* ===== PDF styles ===== */
  #pdfRoot{position:fixed;left:-99999px;top:-99999px;width:900px;background:#fff;color:#111827}
  .r-wrap{padding:18px;border:1px solid #e5e7eb;border-radius:14px}
  .r-head{display:flex;align-items:center;justify-content:space-between;border-bottom:1px dashed #e5e7eb;padding-bottom:12px;margin-bottom:12px}
  .r-head .logos img{height:36px;object-fit:contain}
  .r-title{text-align:center}
  .r-title h1{margin:2px 0 4px;font-size:18px}
  .r-title .addr{font-size:11px;color:#6b7280}
  .r-meta{font-size:11px;text-align:right;color:#374151}
  .r-section{margin-top:12px;border-radius:10px;overflow:hidden;border:1px solid #e5e7eb}
  .r-sec-h{background:#0f172a;color:#fff;padding:8px 10px;font-weight:800}
  .r-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;padding:10px}
  .r-card{border:1px solid #e5e7eb;border-radius:10px;padding:10px}
  .r-row{display:grid;grid-template-columns:140px 1fr;gap:12px;padding:10px}
  .r-row .box{border:1px solid #e5e7eb;border-radius:10px;padding:8px;min-height:48px}
  .r-table{width:100%;border-collapse:collapse;font-size:12px}
  .r-table th,.r-table td{border:1px solid #e5e7eb;padding:8px;vertical-align:top}
  .r-foot{display:flex;gap:12px;padding:12px}
  .sign{flex:1;border:1px dashed #e5e7eb;border-radius:10px;padding:14px;min-height:72px}
  .r-fine{display:flex;justify-content:space-between;font-size:10px;color:#6b7280;padding:8px 2px}

  /* ===== Modal / Overlay ===== */
  .overlay{
    position:fixed;inset:0;background:rgba(15,23,42,.45);
    display:none;align-items:center;justify-content:center;z-index:9999;padding:16px;
  }
  .modal{
    width:min(680px,92vw);max-height:90vh;overflow:auto;
    background:#fff;border:1px solid var(--ring);border-radius:14px;
    box-shadow:0 24px 48px rgba(0,0,0,.28)
  }
  .modal header{display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--ring);padding:12px 14px;border-radius:14px 14px 0 0}
  .modal .body{padding:14px;display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .modal .row-full{grid-column:1 / -1}
  .modal label{display:block;font-size:12px;color:#475569;font-weight:800;margin:0 0 6px}
  .modal footer{display:flex;gap:10px;justify-content:flex-end;border-top:1px solid var(--ring);padding:10px 14px;border-radius:0 0 14px 14px}
</style>
</head>
<body>
<div class="app">
  <!-- Header -->
  <header>
    <div class="spacer"></div>
    <span id="loading"></span>
  </header>

  <!-- Left Navigation Rail -->
  <nav class="rail" aria-label="Quick views">
    <button id="navCalendar" class="active" title="Calendar" type="button">ðŸ“…</button>
    <button id="navTips" title="Tips" type="button">ðŸ’¡</button>
    <button id="navList" title="List View" type="button">ðŸ“‹</button>
  </nav>

  <!-- Filters -->
  <div class="filters">
    <label>Machine</label>
    <select id="filtMa" class="input" style="min-width:140px"><option value="__ALL__">All</option></select>

    <label>Type</label>
    <select id="filtTy" class="input" style="min-width:140px">
      <option value="__ALL__">All</option>
      <option>Preventive</option><option>Corrective</option><option>Calibration</option><option>Inspection</option><option>Others</option>
    </select>

    <label>Status</label>
    <select id="filtSt" class="input" style="min-width:140px">
      <option value="__ALL__">All</option>
      <option>Planned</option><option>In-Progress</option><option>Completed</option><option>Cancelled</option><option>Postponed</option>
    </select>

    <button class="btn ghost" id="btnApplyFilters" type="button">Update</button>
    <button class="btn" id="btnResetFilters" type="button">Reset</button>
  </div>

  <!-- Main area: Calendar/List/Tips -->
  <div id="mainCard" class="card">
    <!-- Calendar view -->
    <div id="viewCalendar"><div id="calendar"></div></div>

    <!-- List view -->
    <div id="viewList" style="display:none;">
      <div class="toolbar-row" id="listToolbar" style="gap:12px;">
        <div style="display:flex;gap:6px;align-items:center">
          <button class="btn" id="listPrev" type="button">â€¹</button>
          <button class="btn" id="listToday" type="button">today</button>
          <button class="btn" id="listNext" type="button">â€º</button>
        </div>
        <strong id="listTitle" style="font-size:15px;">â€”</strong>
        <div class="fc-toolbar-chunk legends">
          <span><span class="legend-box legend-planned"></span> Planned</span>
          <span><span class="legend-box legend-inprogress"></span> In-Progress</span>
          <span><span class="legend-box legend-completed"></span> Completed</span>
          <span><span class="legend-box legend-cancelled"></span> Cancelled</span>
          <span><span class="legend-box legend-postponed"></span> Postponed</span>
          <span class="muted" id="listCount" style="margin-left:14px"></span>
        </div>
      </div>
      <div class="table-wrap">
        <table id="listTable">
          <thead><tr>
            <th>Date</th><th>Start</th><th>Machine</th><th>Title</th><th>Type</th><th>Techs</th><th>Status</th><th>Priority</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Tips view -->
    <div id="viewTips" style="display:none;">
      <div class="tips-grid">
        <section class="tips-col" id="tipsPrev">
          <h4>Maintenance Coverage <span id="tipsPrevCount"></span></h4>
          <div id="tipsPrevBody"></div>
        </section>
        <section class="tips-col" id="tipsCorr">
          <h4>Corrective Maintenance <span id="tipsCorrCount"></span></h4>
          <div id="tipsCorrBody"></div>
        </section>
        <section class="tips-col" id="tipsMiss">
          <h4>Missed Maintenance <span id="tipsMissCount"></span></h4>
          <div id="tipsMissBody"></div>
        </section>
      </div>

      <!-- Info strip (runtime etc.) -->
      <div style="padding:12px;">
        <section class="tips-col" id="tipsInfo" style="max-width:100%;">
          <h4>Info <span id="tipsInfoCount"></span></h4>
          <div id="tipsInfoBody"></div>
        </section>
      </div>
    </div>
  </div>

  <!-- Right details -->
  <aside class="side">
    <h3 class="h6">Maintenance task</h3>
    <div id="details" class="empty">Select a task on the calendar</div>
    <div class="side-actions" id="sideActions" style="display:none">
      <button class="btn danger"  id="btnCancel" type="button">Cancel</button>
      <button class="btn ghost"   id="btnEdit"   type="button">Update</button>
      <button class="btn primary" id="btnNew"    type="button">New</button>
      <button class="btn"         id="btnPDF"    type="button">Download PDF</button>
    </div>
  </aside>
</div>

<!-- Create/Update Modal -->
<div class="overlay" id="overlay">
  <div class="modal">
    <header>
      <div style="font-weight:900" id="modalTitle">Add maintenance task</div>
      <button class="btn" id="closeModal" type="button">Close</button>
    </header>
    <div class="body">
      <div class="row-full">
        <label>Title</label>
        <input id="fTitle" class="input" type="text" placeholder="e.g., Quarterly Service">
      </div>

      <div>
        <label>Machine</label>
<input id="msMachine" type="text" value="Montex_Stenter" readonly />
      </div>
      <div>
        <label>Type</label>
        <select id="fType" class="input">
          <option>Preventive</option><option>Corrective</option><option>Calibration</option><option>Inspection</option><option>Others</option>
        </select>
      </div>

      <div>
        <label>Priority (1=High)</label>
        <select id="fPriority" class="input">
          <option>1</option><option>2</option><option selected>3</option><option>4</option><option>5</option>
        </select>
      </div>
      <div>
        <label>Date</label>
        <input id="fDate" class="input" type="date">
      </div>

      <div>
        <label>Start</label>
        <input id="fTimeStart" class="input" type="time" value="09:00">
      </div>
      <div>
        <label>End</label>
        <input id="fTimeEnd" class="input" type="time" value="11:00">
      </div>

      <div class="row-full">
        <label>Technician(s)</label>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="techOne" class="input" type="text" placeholder="Type a name and click +">
          <button class="btn ghost" id="addTechBtn" type="button">+</button>
        </div>
        <div id="techChips" class="chips"></div>
      </div>

      <!-- Checklist chips (stored as comma-separated MS_Task) -->
      <div class="row-full">
        <label>Checklist points <span class="muted">(stored in MS_Task)</span></label>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="taskOne" class="input" type="text" placeholder="Type a checkpoint and press + or Enter">
          <button class="btn ghost" id="addTaskBtn" type="button">+</button>
        </div>
        <div id="taskChips" class="chips"></div>
      </div>

      <div>
        <label>Status</label>
        <select id="fStatus" class="input">
          <option>Planned</option><option>In-Progress</option><option>Completed</option><option>Cancelled</option><option>Postponed</option>
        </select>
      </div>
      <div class="row-full">
        <label>Description / Notes</label>
        <textarea id="fDesc" class="input" rows="2" placeholder="Optional notes"></textarea>
      </div>
    </div>
    <footer>
      <button class="btn primary" id="saveTask" type="button">Save</button>
    </footer>
  </div>
</div>

<!-- Hidden PDF root -->
<div id="pdfRoot" aria-hidden="true"></div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
<script>
/************ CONFIG ************/
var ORIGIN    = "https://plantwiz.pimateck.in";
var API_BASE  = ORIGIN + "/api";
var DEVICE_ID = "81261350-b886-11f0-87ea-b9809c1a7a9e";
var JWT       = new URLSearchParams(location.search).get("token")  || "";

// Flags
var ATTR_MS_SAVE    = "MS_Save_Button";
var ATTR_MS_UPDATE  = "MS_Update_Buttton";
var ATTR_MS_UPD_TS  = "MS_Update_Timestamp";

// Telemetry keys
var KEYS = [
  "MS_Title","MS_Machine","MS_Type","MS_Priority",
  "MS_Date","MS_Start","MS_End",
  "MS_Status","MS_Description","MS_Technicians","MS_Task"
];

// Simple downtime/runtime flags (0/1, every sample = 1 minute)
var DOWNTIME_KEY = "Downtime";
var RUNTIME_KEY  = "Runtime";

/************ HELPERS ************/
function $(s){ return document.querySelector(s); }
function loading(t){ $("#loading").textContent = t || ""; }
function escapeHtml(s){ return String(s||"").replace(/[&<>\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function pad2(n){ return String(n).padStart(2,"0"); }
function hhmmToMs(baseDate, hhmm){
  var p = String(hhmm||"00:00").split(":"); var h=+p[0]||0, m=+p[1]||0;
  var d = new Date(baseDate); d.setHours(h,m,0,0); return d.getTime();
}
function msToHHMM(ms){
  var d = new Date(ms), h = d.getHours()%12 || 12, ampm = d.getHours()>=12?"PM":"AM";
  return pad2(h)+":"+pad2(d.getMinutes())+" "+ampm;
}
function colorByStatus(s){
  var v = String(s||"Planned").toLowerCase();
  if (v==="cancelled") return "status-cancelled";
  if (v==="in-progress" || v==="inprogress") return "status-inprogress";
  if (v==="completed") return "status-completed";
  if (v==="postponed") return "status-postponed";
  return "status-planned";
}
function eventContent(arg){
  var p = arg.event.extendedProps;
  var time = msToHHMM(p.MS_Start);
  var title = p.MS_Title || "Maintenance";
  return { html: '<span>'+escapeHtml(time)+' â€” '+escapeHtml(title)+'</span>' };
}
function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
function endOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0, 23,59,59,999); }
function startOfDay(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0,0,0,0); }
function endOfDay(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate(), 23,59,59,999); }

function normMachine(s){ return "MONTEX_STENTER"; }  // FIXED MACHINE NAME

function minutesToHM(min){
  if (!isFinite(min) || min<=0) return "0m";
  var h = Math.floor(min/60), m = Math.round(min%60);
  return (h? h+"h ":"") + m + "m";
}
function humanHours(h){
  if (!isFinite(h) || h <= 0) return "0 h";
  if (h >= 24){
    const d = Math.floor(h/24);
    const rem = h - d*24;
    return `${d} d ${rem.toFixed(1)} h`;
  }
  return `${h.toFixed(1)} h`;
}

/* === Consistent 30 complete days ending yesterday 23:59:59 === */
function last30FullDaysRange(){
  const now = new Date();
  const y0 = new Date(now.getFullYear(), now.getMonth(), now.getDate()-1, 0,0,0,0);
  const start = new Date(y0.getFullYear(), y0.getMonth(), y0.getDate()-29, 0,0,0,0);
  const end   = new Date(y0.getFullYear(), y0.getMonth(), y0.getDate(), 23,59,59,999);
  return { start, end };
}

/************ STATE ************/
var state = {
  view: "calendar",
  calendar:null, lastRange:null, selectedEvent:null, mode:"create",
  pickedDate: null,
  technicians: [],
  taskItems: [], 
  filters: { ty:"__ALL__", st:"__ALL__" },  // Removed machine filter
  lastEventsFull: [],
  listMonth: null,
  lastListRange: null
};

/************ READ (Maintenance events) ************/
function readRange(rangeStart, rangeEnd){
  if(!JWT){ return Promise.reject(new Error("Missing JWT (?token=)")); }
  var url = API_BASE + "/plugins/telemetry/DEVICE/" + DEVICE_ID + "/values/timeseries"
          + "?keys=" + encodeURIComponent(KEYS.join(",")) +
            "&startTs=" + rangeStart.getTime() +
            "&endTs="   + rangeEnd.getTime() +
            "&limit=5000";

  return fetch(url, { headers: { "X-Authorization": "Bearer " + JWT } })
    .then(res => res.ok ? res.json() : res.text().then(t => { throw new Error("Timeseries read failed: "+t); }))
    .then(tsObj => {
      
      var map = {};
      Object.keys(tsObj || {}).forEach(k => {
        (tsObj[k]||[]).forEach(p => {
          var ts = Number(p.ts);
          var rec = map[ts] || (map[ts] = { ts: ts });
          rec[k] = p.value;
        });
      });

      var out = [];
      Object.keys(map).forEach(tsStr => {
        var r = map[tsStr];
        var st = Number(r.MS_Start || r.ts);
        var en = Number(r.MS_End || (st + 60*60*1000));
        out.push({
          id: "ts-"+r.ts,
          title: r.MS_Title || "Maintenance",
          start: new Date(st),
          end:   new Date(en),
          classNames: ["event", colorByStatus(r.MS_Status)],
          extendedProps: {
            MS_Title: r.MS_Title || "",   
            MS_Machine: "Montex_Stenter",  
            MS_Type: r.MS_Type || "Preventive",   
            MS_Priority: r.MS_Priority != null ? r.MS_Priority : 3,   
            MS_Date: r.MS_Date || null,
            MS_Start: st,     
            MS_End: en, 
            MS_Status: String(r.MS_Status || "Planned"),
            MS_Description: r.MS_Description || "",    
            MS_Technicians: r.MS_Technicians || "",   
            MS_Task: r.MS_Task || "",
            __ts: r.ts
          }
        });
      });
      out.sort((a,b)=>a.start-b.start);
      return out;
    });
}

/************ READ Downtime + Runtime ************/
async function readDowntimeAndRuntime() {
  if (!JWT) throw new Error("Missing JWT");

  const { start, end } = last30FullDaysRange();

  const url =
    API_BASE +
    "/plugins/telemetry/DEVICE/" +
    DEVICE_ID +
    "/values/timeseries?keys=" +
    encodeURIComponent(DOWNTIME_KEY + "," + RUNTIME_KEY) +
    "&startTs=" + start.getTime() +
    "&endTs=" + end.getTime() +
    "&limit=20000";

  const res = await fetch(url, {
    headers: { "X-Authorization": "Bearer " + JWT }
  });

  if (!res.ok) {
    throw new Error("Failed to read Downtime/Runtime");
  }

  const obj = await res.json();

  return {
    start,
    end,
    downtimeArr: (obj[DOWNTIME_KEY] || []).sort((a, b) => a.ts - b.ts),
    runtimeArr:  (obj[RUNTIME_KEY]  || []).sort((a, b) => a.ts - b.ts)
  };
}

/************ LIST RENDER ************/
function badge(status){
  var c = String(status||"Planned").toLowerCase().replace("in-progress","inprogress");
  return '<span class="badge '+c+'">'+escapeHtml(status||"Planned")+'</span>';
}
function renderList(events){
  var tbody = $("#listTable tbody"); tbody.innerHTML = "";
  events.forEach(ev=>{
    var p = ev.extendedProps;
    var tr = document.createElement("tr");
    tr.innerHTML =
      '<td>'+escapeHtml(new Date(p.MS_Start).toLocaleDateString())+'</td>'+
      '<td>'+escapeHtml(msToHHMM(p.MS_Start))+'</td>'+
      '<td>Montex_Stenter</td>'+
      '<td>'+escapeHtml(p.MS_Title||"-")+'</td>'+
      '<td>'+escapeHtml(p.MS_Type||"-")+'</td>'+
      '<td>'+escapeHtml(p.MS_Technicians||"-")+'</td>'+
      '<td>'+badge(p.MS_Status)+'</td>'+
      '<td>'+escapeHtml(String(p.MS_Priority??""))+'</td>';
    tr.addEventListener("click", function(){ showDetails({ extendedProps: p }); });
    tbody.appendChild(tr);
  });
  $("#listCount").textContent = "Showing "+events.length+" task(s)";
}

/************ VIEW SWITCH ************/
function showView(name){
  state.view = name;
  $("#viewCalendar").style.display = name==="calendar"?"block":"none";
  $("#viewList").style.display     = name==="list"?"block":"none";
  $("#viewTips").style.display     = name==="tips"?"block":"none";

  if (name==="tips"){
    renderTips();
  }
}

/************ CREATE / UPDATE MODAL ************/
function openModalForDate(jsDate){
  state.mode="create";

  state.pickedDate = new Date(jsDate.getFullYear(), jsDate.getMonth(), jsDate.getDate());

  $("#modalTitle").textContent="Add maintenance task";
  $("#saveTask").textContent="Save";

  $("#fTitle").value="";
  $("#fMachine").value="Montex_Stenter";

  $("#fType").value="Preventive";
  $("#fPriority").value="3";

  $("#fDate").value = new Date(state.pickedDate.getTime() - state.pickedDate.getTimezoneOffset()*60000).toISOString().slice(0,10);

  $("#fTimeStart").value="09:00";
  $("#fTimeEnd").value="11:00";

  state.technicians=[];
  refreshTechChips();
  $("#techOne").value="";

  $("#fStatus").value="Planned";
  $("#fDesc").value="";

  state.taskItems=[];
  refreshTaskChips();
  $("#taskOne").value="";

  overlay.style.display="flex";
  document.body.style.overflow="hidden";
}

function collectPayload(){
  var dateStr = $("#fDate").value;
  var parts = dateStr ? dateStr.split("-").map(Number) : null;
  var base = parts ? new Date(parts[0], parts[1]-1, parts[2]) : (state.pickedDate || new Date());
  return {
    MS_Title: ($("#fTitle").value||"").trim(),
    MS_Machine: "Montex_Stenter",
    MS_Type: $("#fType").value || "Preventive",
    MS_Priority: parseInt($("#fPriority").value, 10) || 3,
    MS_Date: new Date(base.getFullYear(), base.getMonth(), base.getDate()).getTime(),
    MS_Start: hhmmToMs(base, $("#fTimeStart").value),
    MS_End:   hhmmToMs(base, $("#fTimeEnd").value),
    MS_Status: $("#fStatus").value || "Planned",
    MS_Description: ($("#fDesc").value||"").trim(),
    MS_Technicians: state.technicians.join(", "),
    MS_Task: state.taskItems.join(", ")
  };
}

function validatePayload(p){
  if (!p.MS_Title) return "Please enter Title";
  if (!p.MS_Technicians) return "Please enter Technician";
  if (p.MS_End <= p.MS_Start) return "End time must be after Start time.";
  return "";
}

function onCreate(){
  var payload = collectPayload();
  var err = validatePayload(payload);
  if (err){ alert(err); return; }

  writeAttributes(payload, { mode:"create" })
    .then(()=>{ closeOverlay(); })
    .catch(err=>alert(err.message||"Failed to save"));
}

function onUpdate(){
  if(!state.selectedEvent){ alert("Select a task"); return; }

  var payload = collectPayload();
  payload[ATTR_MS_UPD_TS] = state.selectedEvent.extendedProps.__ts;

  var err = validatePayload(payload);
  if (err){ alert(err); return; }

  writeAttributes(payload, { mode:"update" })
    .then(()=>{ closeOverlay(); })
    .catch(err=>alert(err.message||"Failed to update"));
}

/************ TIPS ENGINE ************/
async function tipsCorrectiveTelemetry() {
  try {
    const { start, end, downtimeArr, runtimeArr } = await readDowntimeAndRuntime();

    const totalDowntimeMinutes = downtimeArr.filter(p => Number(p.value) === 1).length;

    let occurrences = 0;
    for (let i = 1; i < downtimeArr.length; i++) {
      if (Number(downtimeArr[i - 1].value) === 0 && Number(downtimeArr[i].value) === 1)
        occurrences++;
    }

    const totalRuntimeMinutes = runtimeArr.filter(p => Number(p.value) === 1).length;
    const totalRuntimeHours = totalRuntimeMinutes / 60;

    const MTTF = occurrences > 0 ? (totalRuntimeHours / occurrences) : 0;
    const MTTR = occurrences > 0 ? (totalDowntimeMinutes / occurrences) : 0;

    return [
      {
        severity: totalDowntimeMinutes > 250 || occurrences > 5 ? "High" : "Medium",
        title: "Corrective Maintenance â€” Montex_Stenter",
        subtitle: `Window: ${start.toLocaleDateString()} â†’ ${end.toLocaleDateString()}`,
        body:
          `â€¢ Total Downtime: ${totalDowntimeMinutes} minutes\n` +
          `â€¢ Downtime Occurrences: ${occurrences}\n` +
          `â€¢ Runtime: ${totalRuntimeHours.toFixed(1)} hours\n\n` +
          `â€¢ MTTF: ${MTTF.toFixed(1)} hours\n` +
          `â€¢ MTTR: ${MTTR.toFixed(1)} minutes\n`,
        cta: { label: "Create Task", action: () => openModalForDate(new Date()) }
      }
    ];

  } catch (err) {
    return [
      { severity: "Info", title: "Corrective data unavailable",
        body: "Unable to read Downtime / Runtime." }
    ];
  }
}

/************ PREVENTIVE RUNTIME ************/
async function tipsPreventiveRuntime(){
  return [
    {
      severity: "Info",
      title: "Runtime Monitor â€” Montex_Stenter",
      subtitle: "Runtime-based insights coming soon",
      body: "Runtime telemetry is being captured and basic analytics are available.",
      cta: { label:"Schedule", action: ()=>openModalForDate(new Date()) }
    }
  ];
}

/************ COVERAGE ************/
async function tipsPreventiveCoverage(){
  return [
    {
      severity: "Medium",
      title: "Low Maintenance Coverage â€” Montex_Stenter",
      subtitle: "This month has fewer maintenance events than recommended.",
      body: "Consider scheduling preventive tasks to avoid unexpected shutdown.",
      cta: { label:"Add Task", action: ()=>openModalForDate(new Date()) }
    }
  ];
}

/************ MISSED ************/
async function tipsMissed(){
  return [];
}

/************ RENDER TIPS ************/
async function renderTips(){
  const prev = await tipsPreventiveCoverage();
  const corr = await tipsCorrectiveTelemetry();
  const info = await tipsPreventiveRuntime();

  $("#tipsPrevBody").innerHTML = prev.map(t=>tipCardHTML(t)).join("");
  $("#tipsCorrBody").innerHTML = corr.map(t=>tipCardHTML(t)).join("");
  $("#tipsInfoBody").innerHTML = info.map(t=>tipCardHTML(t)).join("");
  $("#tipsMissBody").innerHTML = `<div class="tip-empty">No missed items.</div>`;
}

/************ HELPERS FOR TIPS ************/
function tipCardHTML(t){
  return `
    <div class="tip-card">
      <div class="tip-title-row">
        <span class="tip-title">${escapeHtml(t.title)}</span>
        <span class="chip-note">${escapeHtml(t.severity||"")}</span>
      </div>
      ${t.subtitle? `<div class="muted">${escapeHtml(t.subtitle)}</div>` : ""}
      <div class="tip-body">${escapeHtml(t.body||"")}</div>
      ${ t.cta ? `<button class="btn" type="button">${escapeHtml(t.cta.label)}</button>` : "" }
    </div>
  `;
}

/************ CALENDAR ************/
function startCalendar(){
  const calEl = $("#calendar");
  state.calendar = new FullCalendar.Calendar(calEl, {
    initialView: "dayGridMonth",
    eventContent: eventContent,
    dateClick: info => openModalForDate(info.date),
    eventClick: info => showDetails(info.event),
    datesSet: info => {
      readRange(info.start, info.end).then(events=>{
        state.lastEventsFull = events;
        state.calendar.removeAllEvents();
        state.calendar.addEventSource(events);
      });
    }
  });

  state.calendar.render();
}

document.addEventListener("DOMContentLoaded", startCalendar);
</script>

</body>
</html>
