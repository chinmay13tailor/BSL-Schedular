<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Maintenance Scheduler</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css">
<style>
  :root{--ring:#e5e7eb;--bg:#fff;--text:#0f172a;--muted:#64748b;
        --blue:#3b82f6;--green:#22c55e;--amber:#f59e0b;--red:#ef4444;--slate:#111827;--gray:#6b7280}
  *{box-sizing:border-box}
  body{margin:0;background:#fff;color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}

  /* ======= LAYOUT (Header | Filters | Rail + Main + Side) ======= */
  .app{
    display:grid;
    grid-template-columns:64px 1fr 320px;     /* rail | main | right side */
    grid-template-rows:auto auto 1fr;         /* header | filters | content row */
    gap:16px;
    min-height:100vh;
    padding:16px;
  }

  header{
    grid-column:1 / -1;
    display:flex;gap:10px;align-items:center;
    border:1px solid var(--ring);border-radius:12px;background:#fff;padding:10px 12px
  }
  .spacer{flex:1}

  /* Filters (span main + side) */
  .filters{
    grid-column:2 / -1;
    display:flex;align-items:center;gap:10px;
    border:1px solid var(--ring);border-radius:12px;background:#fff;padding:10px 12px
  }
  .filters label{font-size:12px;color:#64748b;margin-right:4px}

  /* Left navigation rail */
  .rail{
    grid-column:1 / 2;
    grid-row:3 / 4;
    border:1px solid var(--ring);border-radius:12px;background:#fff;padding:8px;
    display:flex;flex-direction:column;align-items:center;gap:8px;
    position:sticky;top:16px;height:fit-content
  }
  .rail button{
    width:48px;height:48px;border-radius:12px;border:1px solid var(--ring);
    background:#fff;cursor:pointer;display:grid;place-items:center;font-size:18px
  }
  .rail button.active{border-color:#2563eb;box-shadow:0 0 0 2px rgba(37,99,235,.15)}
  .rail button:hover{background:#f8fafc}

  /* Main area (calendar/list container) */
  .card{border:1px solid var(--ring);border-radius:12px;background:#fff;overflow:hidden}
  #mainCard{grid-column:2 / 3;grid-row:3 / 4;min-height:560px}
  #calendar{min-height:560px}

  /* Right side details */
  .side{
    grid-column:3 / 4;grid-row:3 / 4;
    border:1px solid var(--ring);border-radius:12px;background:#fff;padding:14px;
    position:sticky;top:16px;height:fit-content
  }

  .empty{padding:12px;text-align:center;color:#64748b;background:#f8fafc;border-radius:10px}
  .h6{margin:0 0 10px;font-weight:900}
  .kpi{display:grid;grid-template-columns:120px 1fr;gap:8px;font-size:13px}
  .kpi span:first-child{color:#64748b}
  .side-actions{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}

  .btn,.input,textarea,select{border:1px solid var(--ring);border-radius:10px;background:#fff;padding:8px 10px}
  .btn{cursor:pointer;font-weight:800}
  .btn.primary{background:linear-gradient(#3b82f6,#2563eb);color:#fff;border:0}
  .btn.danger{border-color:var(--red);color:#dc2626}
  .btn.ghost{border-color:var(--ring);color:#0f172a}
  .btn:disabled{opacity:.6;cursor:not-allowed}

  .muted{color:#64748b}
  #loading{font-size:12px;color:#64748b;margin-left:8px}

  /* FullCalendar styles */
  .fc .fc-toolbar{padding:10px}
  .fc .fc-toolbar-title{font-size:16px;font-weight:800}
  .fc .fc-button{background:#fff;border:1px solid var(--ring);color:#0f172a;border-radius:10px;padding:6px 10px}
  .fc-theme-standard td,.fc-theme-standard th{border-color:var(--ring)}
  .fc-daygrid-day-number{color:#64748b}

  .event{border-radius:10px;border:0;padding:6px 8px;color:#fff;font-weight:700;box-shadow:0 1px 0 rgba(0,0,0,.08),0 8px 16px -12px rgba(0,0,0,.25)}
  .status-planned{background:var(--blue)}
  .status-inprogress{background:var(--amber)}
  .status-completed{background:var(--green)}
  .status-cancelled{background:var(--red)}
  .status-postponed{background:var(--gray)}

  .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid var(--ring);border-radius:999px;font-size:12px;background:#f8fafc}
  .chip button{border:0;background:transparent;cursor:pointer;font-weight:900;line-height:1}

  .fc-toolbar-chunk.legends{display:flex;gap:14px;align-items:center;margin-left:8px}
  .legend-box{display:inline-block;width:12px;height:12px;border-radius:3px;margin-right:6px}
  .legend-planned{background:var(--blue)}
  .legend-inprogress{background:var(--amber)}
  .legend-completed{background:var(--green)}
  .legend-cancelled{background:var(--red)}
  .legend-postponed{background:var(--gray)}

  /* ===== List tables ===== */
  .toolbar-row{display:flex;align-items:center;justify-content:space-between;padding:10px;border-bottom:1px solid var(--ring)}
  .table-wrap{overflow:auto;max-height:68vh}
  table{width:100%;border-collapse:collapse;font-size:13px}
  thead th{position:sticky;top:0;background:#f8fafc;z-index:1}
  th,td{border-bottom:1px solid var(--ring);padding:8px 10px;text-align:left;white-space:nowrap}
  tr:hover{background:#f9fafb;cursor:pointer}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;color:#fff;font-weight:700;font-size:11px}
  .badge.planned{background:var(--blue)} .badge.inprogress{background:var(--amber)}
  .badge.completed{background:var(--green)} .badge.cancelled{background:var(--red)} .badge.postponed{background:var(--gray)}
  .chip-note{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border:1px solid var(--ring);border-radius:999px;font-size:11px;background:#f8fafc;color:#475569}

  /* ===== Tips layout ===== */
  .tips-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;padding:12px}
  .tips-col{border:1px solid var(--ring);border-radius:12px;background:#fff;overflow:hidden;display:flex;flex-direction:column}

  .tips-col h4{margin:0;padding:10px 12px;font-weight:900;border-bottom:1px solid var(--ring);text-align:center}
  .tips-col h4 span{
    display:inline-block;margin-left:8px;padding:2px 8px;border-radius:999px;background:rgba(255,255,255,.22);color:inherit;font-weight:700;font-size:12px
  }
  #tipsPrev > h4{ background:var(--blue);  color:#fff;     border-bottom:0; }
  #tipsCorr > h4{ background:var(--amber); color:#111827;  border-bottom:0; }
  #tipsMiss > h4{ background:var(--red);   color:#fff;     border-bottom:0; }

  .tip-card{border-bottom:1px solid var(--ring);padding:12px}
  .tip-card:last-child{border-bottom:0}
  .tip-title{font-weight:900;margin-bottom:6px}
  .tip-body{color:#334155;white-space:pre-line}
  .tip-actions{margin-top:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .tip-empty{padding:14px;color:#64748b;text-align:center;background:#f8fafc;margin:10px;border-radius:10px}

  /* Tips loader */
  .tips-loading{display:flex;align-items:center;justify-content:center;padding:28px;color:#64748b}
  .tips-loading::after{
    content:""; width:16px;height:16px; margin-left:10px; border-radius:50%;
    border:2px solid #cbd5e1;border-top-color:#64748b; animation:spin 0.8s linear infinite;
  }
  @keyframes spin{to{transform:rotate(360deg)}}

  /* ===== PDF styles ===== */
  #pdfRoot{position:fixed;left:-99999px;top:-99999px;width:900px;background:#fff;color:#111827}
  .r-wrap{padding:18px;border:1px solid #e5e7eb;border-radius:14px}
  .r-head{display:flex;align-items:center;justify-content:space-between;border-bottom:1px dashed #e5e7eb;padding-bottom:12px;margin-bottom:12px}
  .r-head .logos img{height:36px;object-fit:contain}
  .r-title{text-align:center}
  .r-title h1{margin:2px 0 4px;font-size:18px}
  .r-title .addr{font-size:11px;color:#6b7280}
  .r-meta{font-size:11px;text-align:right;color:#374151}
  .r-section{margin-top:12px;border-radius:10px;overflow:hidden;border:1px solid #e5e7eb}
  .r-sec-h{background:#0f172a;color:#fff;padding:8px 10px;font-weight:800}
  .r-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;padding:10px}
  .r-card{border:1px solid #e5e7eb;border-radius:10px;padding:10px}
  .r-row{display:grid;grid-template-columns:140px 1fr;gap:12px;padding:10px}
  .r-row .box{border:1px solid #e5e7eb;border-radius:10px;padding:8px;min-height:48px}
  .r-table{width:100%;border-collapse:collapse;font-size:12px}
  .r-table th,.r-table td{border:1px solid #e5e7eb;padding:8px;vertical-align:top}
  .r-foot{display:flex;gap:12px;padding:12px}
  .sign{flex:1;border:1px dashed #e5e7eb;border-radius:10px;padding:14px;min-height:72px}
  .r-fine{display:flex;justify-content:space-between;font-size:10px;color:#6b7280;padding:8px 2px}

  /* ===== Modal / Overlay ===== */
  .overlay{
    position:fixed;inset:0;background:rgba(15,23,42,.45);
    display:none;align-items:center;justify-content:center;z-index:9999;padding:16px;
  }
  .modal{
    width:min(680px,92vw);max-height:90vh;overflow:auto;
    background:#fff;border:1px solid var(--ring);border-radius:14px;
    box-shadow:0 24px 48px rgba(0,0,0,.28)
  }
  .modal header{display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--ring);padding:12px 14px;border-radius:14px 14px 0 0}
  .modal .body{padding:14px;display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .modal .row-full{grid-column:1 / -1}
  .modal label{display:block;font-size:12px;color:#475569;font-weight:800;margin:0 0 6px}
  .modal footer{display:flex;gap:10px;justify-content:flex-end;border-top:1px solid var(--ring);padding:10px 14px;border-radius:0 0 14px 14px}
</style>
</head>
<body>
<div class="app">
  <!-- Header -->
  <header>
    <div class="spacer"></div>
    <span id="loading"></span>
  </header>

  <!-- Left Navigation Rail -->
  <nav class="rail" aria-label="Quick views">
    <button id="navCalendar" class="active" title="Calendar" type="button">üìÖ</button>
    <button id="navTips" title="Tips" type="button">üí°</button>
    <button id="navList" title="List View" type="button">üìã</button>
  </nav>

  <!-- Filters -->
  <div class="filters">
    <label>Machine</label>
    <select id="filtMa" class="input" style="min-width:140px"><option value="__ALL__">All</option></select>

    <label>Type</label>
    <select id="filtTy" class="input" style="min-width:140px">
      <option value="__ALL__">All</option>
      <option>Preventive</option><option>Corrective</option><option>Calibration</option><option>Inspection</option><option>Others</option>
    </select>

    <label>Status</label>
    <select id="filtSt" class="input" style="min-width:140px">
      <option value="__ALL__">All</option>
      <option>Planned</option><option>In-Progress</option><option>Completed</option><option>Cancelled</option><option>Postponed</option>
    </select>

    <button class="btn ghost" id="btnApplyFilters" type="button">Update</button>
    <button class="btn" id="btnResetFilters" type="button">Reset</button>
  </div>

  <!-- Main area: Calendar/List/Tips -->
  <div id="mainCard" class="card">
    <!-- Calendar view -->
    <div id="viewCalendar"><div id="calendar"></div></div>

    <!-- List view -->
    <div id="viewList" style="display:none;">
      <div class="toolbar-row" id="listToolbar" style="gap:12px;">
        <div style="display:flex;gap:6px;align-items:center">
          <button class="btn" id="listPrev" type="button">‚Äπ</button>
          <button class="btn" id="listToday" type="button">today</button>
          <button class="btn" id="listNext" type="button">‚Ä∫</button>
        </div>
        <strong id="listTitle" style="font-size:15px;">‚Äî</strong>
        <div class="fc-toolbar-chunk legends">
          <span><span class="legend-box legend-planned"></span> Planned</span>
          <span><span class="legend-box legend-inprogress"></span> In-Progress</span>
          <span><span class="legend-box legend-completed"></span> Completed</span>
          <span><span class="legend-box legend-cancelled"></span> Cancelled</span>
          <span><span class="legend-box legend-postponed"></span> Postponed</span>
          <span class="muted" id="listCount" style="margin-left:14px"></span>
        </div>
      </div>
      <div class="table-wrap">
        <table id="listTable">
          <thead><tr>
            <th>Date</th><th>Start</th><th>Machine</th><th>Title</th><th>Type</th><th>Techs</th><th>Status</th><th>Priority</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Tips view -->
    <div id="viewTips" style="display:none;">
      <div class="tips-grid">
        <section class="tips-col" id="tipsPrev">
          <h4>Maintenance Coverage <span id="tipsPrevCount"></span></h4>
          <div id="tipsPrevBody"></div>
        </section>
        <section class="tips-col" id="tipsCorr">
          <h4>Corrective Maintenance <span id="tipsCorrCount"></span></h4>
          <div id="tipsCorrBody"></div>
        </section>
        <section class="tips-col" id="tipsMiss">
          <h4>Missed Maintenance <span id="tipsMissCount"></span></h4>
          <div id="tipsMissBody"></div>
        </section>
      </div>

      <!-- Info strip (runtime etc.) -->
      <div style="padding:12px;">
        <section class="tips-col" id="tipsInfo" style="max-width:100%;">
          <h4>Info <span id="tipsInfoCount"></span></h4>
          <div id="tipsInfoBody"></div>
        </section>
      </div>
    </div>
  </div>

  <!-- Right details -->
  <aside class="side">
    <h3 class="h6">Maintenance task</h3>
    <div id="details" class="empty">Select a task on the calendar</div>
    <div class="side-actions" id="sideActions" style="display:none">
      <button class="btn danger"  id="btnCancel" type="button">Cancel</button>
      <button class="btn ghost"   id="btnEdit"   type="button">Update</button>
      <button class="btn primary" id="btnNew"    type="button">New</button>
      <button class="btn"         id="btnPDF"    type="button">Download PDF</button>
    </div>
  </aside>
</div>

<!-- Create/Update Modal -->
<div class="overlay" id="overlay">
  <div class="modal">
    <header>
      <div style="font-weight:900" id="modalTitle">Add maintenance task</div>
      <button class="btn" id="closeModal" type="button">Close</button>
    </header>
    <div class="body">
      <div class="row-full">
        <label>Title</label>
        <input id="fTitle" class="input" type="text" placeholder="e.g., Quarterly Service">
      </div>

      <div>
        <label>Machine</label>
<input id="msMachine" type="text" value="Montex_Stenter" readonly />
      </div>
      <div>
        <label>Type</label>
        <select id="fType" class="input">
          <option>Preventive</option><option>Corrective</option><option>Calibration</option><option>Inspection</option><option>Others</option>
        </select>
      </div>

      <div>
        <label>Priority (1=High)</label>
        <select id="fPriority" class="input">
          <option>1</option><option>2</option><option selected>3</option><option>4</option><option>5</option>
        </select>
      </div>
      <div>
        <label>Date</label>
        <input id="fDate" class="input" type="date">
      </div>

      <div>
        <label>Start</label>
        <input id="fTimeStart" class="input" type="time" value="09:00">
      </div>
      <div>
        <label>End</label>
        <input id="fTimeEnd" class="input" type="time" value="11:00">
      </div>

      <div class="row-full">
        <label>Technician(s)</label>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="techOne" class="input" type="text" placeholder="Type a name and click +">
          <button class="btn ghost" id="addTechBtn" type="button">+</button>
        </div>
        <div id="techChips" class="chips"></div>
      </div>

      <!-- Checklist chips (stored as comma-separated MS_Task) -->
      <div class="row-full">
        <label>Checklist points <span class="muted">(stored in MS_Task)</span></label>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="taskOne" class="input" type="text" placeholder="Type a checkpoint and press + or Enter">
          <button class="btn ghost" id="addTaskBtn" type="button">+</button>
        </div>
        <div id="taskChips" class="chips"></div>
      </div>

      <div>
        <label>Status</label>
        <select id="fStatus" class="input">
          <option>Planned</option><option>In-Progress</option><option>Completed</option><option>Cancelled</option><option>Postponed</option>
        </select>
      </div>
      <div class="row-full">
        <label>Description / Notes</label>
        <textarea id="fDesc" class="input" rows="2" placeholder="Optional notes"></textarea>
      </div>
    </div>
    <footer>
      <button class="btn primary" id="saveTask" type="button">Save</button>
    </footer>
  </div>
</div>

<!-- Hidden PDF root -->
<div id="pdfRoot" aria-hidden="true"></div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
<script>
/************ CONFIG ************/
const ORIGIN   = "https://plantwiz.pimateck.in";
const API_BASE = ORIGIN + "/api";
const DEVICE_ID = "81261350-b886-11f0-87ea-b9809c1a7a9e";

// JWT from ?token=
const JWT = new URLSearchParams(location.search).get("token") || "";

// Flags (note the key name with double 'tt' as per your ThingsBoard attribute)
const ATTR_MS_SAVE   = "MS_Save_Button";
const ATTR_MS_UPDATE = "MS_Update_Buttton";
const ATTR_MS_UPD_TS = "MS_Update_Timestamp";

// Telemetry keys
const KEYS = [
  "MS_Title","MS_Machine","MS_Type","MS_Priority",
  "MS_Date","MS_Start","MS_End",
  "MS_Status","MS_Description","MS_Technicians","MS_Task"
];

// Downtime/runtime keys
const DOWNTIME_KEY = "Downtime";
const RUNTIME_KEY  = "Runtime";

/************ HELPERS ************/
function $(s){ return document.querySelector(s); }

function loading(t){
  const el = $("#loading");
  if (el) el.textContent = t || "";
}

function escapeHtml(s){
  return String(s || "").replace(/[&<>\"']/g, m =>
    ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])
  );
}

function pad2(n){ return String(n).padStart(2,"0"); }

function hhmmToMs(baseDate, hhmm){
  const p = String(hhmm || "00:00").split(":");
  const h = +p[0] || 0;
  const m = +p[1] || 0;
  const d = new Date(baseDate);
  d.setHours(h,m,0,0);
  return d.getTime();
}

function msToHHMM(ms){
  const d = new Date(ms);
  const h24 = d.getHours();
  const h = h24 % 12 || 12;
  const ampm = h24 >= 12 ? "PM":"AM";
  return pad2(h) + ":" + pad2(d.getMinutes()) + " " + ampm;
}

function colorByStatus(s){
  const v = String(s || "Planned").toLowerCase();
  if (v === "cancelled") return "status-cancelled";
  if (v === "in-progress" || v === "inprogress") return "status-inprogress";
  if (v === "completed") return "status-completed";
  if (v === "postponed") return "status-postponed";
  return "status-planned";
}

function eventContent(arg){
  const p = arg.event.extendedProps;
  const time = msToHHMM(p.MS_Start);
  const title = p.MS_Title || "Maintenance";
  return { html: `<span>${escapeHtml(time)} ‚Äî ${escapeHtml(title)}</span>` };
}

function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
function endOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0, 23,59,59,999); }
function startOfDay(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0,0,0,0); }
function endOfDay(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate(), 23,59,59,999); }

function normMachine(s){ return String(s || "").trim().toUpperCase(); }

function last30FullDaysRange(){
  const now = new Date();
  const y0 = new Date(now.getFullYear(), now.getMonth(), now.getDate()-1, 0,0,0,0);
  const start = new Date(y0.getFullYear(), y0.getMonth(), y0.getDate()-29, 0,0,0,0);
  const end   = new Date(y0.getFullYear(), y0.getMonth(), y0.getDate(), 23,59,59,999);
  return { start, end };
}

/************ STATE ************/
const state = {
  view: "calendar",
  calendar: null,
  lastRange: null,
  selectedEvent: null,
  mode: "create",
  pickedDate: null,
  technicians: [],
  taskItems: [],
  filters: { ma:"__ALL__", ty:"__ALL__", st:"__ALL__" },
  lastEventsFull: [],
  listMonth: null,
  lastListRange: null
};

let overlay = null;

// Auto refresh loop (used for create & cancel flows)
let _autoTimer = null;
let _autoDeadline = 0;

function stopAutoRefresh(){
  if (_autoTimer){
    clearInterval(_autoTimer);
    _autoTimer = null;
  }
}

/************ READ Maintenance Events ************/
function readRange(rangeStart, rangeEnd){
  if (!JWT) return Promise.reject(new Error("Missing JWT (?token=)"));

  const url = API_BASE + "/plugins/telemetry/DEVICE/" + DEVICE_ID + "/values/timeseries" +
    "?keys=" + encodeURIComponent(KEYS.join(",")) +
    "&startTs=" + rangeStart.getTime() +
    "&endTs="   + rangeEnd.getTime() +
    "&limit=5000";

  return fetch(url, { headers: { "X-Authorization": "Bearer " + JWT } })
    .then(res => res.ok ? res.json() : res.text().then(t => { throw new Error("Timeseries read failed: " + t); }))
    .then(tsObj => {
      const map = {};
      Object.keys(tsObj || {}).forEach(k => {
        (tsObj[k] || []).forEach(p => {
          const ts = Number(p.ts);
          const rec = map[ts] || (map[ts] = { ts });
          rec[k] = p.value;
        });
      });

      const out = [];
      Object.keys(map).forEach(tsStr => {
        const r = map[tsStr];
        const st = Number(r.MS_Start || r.ts);
        const en = Number(r.MS_End || (st + 60*60*1000));
        if (!st || !en) return;

        out.push({
          id: "ts-" + r.ts,
          title: r.MS_Title || "Maintenance",
          start: new Date(st),
          end:   new Date(en),
          classNames: ["event", colorByStatus(r.MS_Status)],
          extendedProps: {
            MS_Title: r.MS_Title || "",
            MS_Machine: r.MS_Machine || "Montex_Stenter",
            MS_Type: r.MS_Type || "Preventive",
            MS_Priority: r.MS_Priority != null ? r.MS_Priority : 3,
            MS_Date: r.MS_Date || null,
            MS_Start: st,
            MS_End: en,
            MS_Status: String(r.MS_Status || "Planned").trim().replace(/inprogress/i,"In-Progress"),
            MS_Description: r.MS_Description || "",
            MS_Technicians: r.MS_Technicians || "",
            MS_Task: r.MS_Task || "",
            __ts: r.ts
          }
        });
      });

      out.sort((a,b) => a.start - b.start);
      return out;
    });
}

/************ READ Downtime + Runtime (30 days) ************/
async function readDowntimeAndRuntime(){
  if (!JWT) throw new Error("Missing JWT");

  const { start, end } = last30FullDaysRange();

  const url = API_BASE + "/plugins/telemetry/DEVICE/" + DEVICE_ID + "/values/timeseries" +
    "?keys=" + encodeURIComponent(DOWNTIME_KEY + "," + RUNTIME_KEY) +
    "&startTs=" + start.getTime() +
    "&endTs="   + end.getTime() +
    "&limit=20000";

  const res = await fetch(url, {
    headers: { "X-Authorization": "Bearer " + JWT }
  });

  if (!res.ok) throw new Error("Failed to read Downtime/Runtime");

  const obj = await res.json();

  return {
    start,
    end,
    downtimeArr: (obj[DOWNTIME_KEY] || []).sort((a,b) => a.ts - b.ts),
    runtimeArr:  (obj[RUNTIME_KEY]  || []).sort((a,b) => a.ts - b.ts)
  };
}

/************ FILTERS ************/
function populateFilters(events){
  const mas = new Set();
  events.forEach(ev => {
    const p = ev.extendedProps || {};
    if (p.MS_Machine) mas.add(String(p.MS_Machine));
  });

  function fill(sel, set){
    const el = $(sel);
    if (!el) return;
    const val = el.value || "__ALL__";
    el.innerHTML = '<option value="__ALL__">All</option>' +
      Array.from(set).sort().map(v => `<option>${escapeHtml(v)}</option>`).join('');
    if ([...set].includes(val)) el.value = val;
    else el.value = "__ALL__";
  }

  fill("#filtMa", mas);
}

function applyFilters(events){
  const ma = $("#filtMa").value;
  const ty = $("#filtTy").value;
  const st = $("#filtSt").value;
  state.filters = { ma, ty, st };
  const maNorm = normMachine(ma);

  return events.filter(ev => {
    const p = ev.extendedProps || {};
    const okMa = (ma === "__ALL__" || normMachine(p.MS_Machine) === maNorm);
    const okTy = (ty === "__ALL__" || String(p.MS_Type) === ty);
    const okSt = (st === "__ALL__" || String(p.MS_Status) === st);
    return okMa && okTy && okSt;
  });
}

/************ LIST RENDER ************/
function badge(status){
  const c = String(status || "Planned").toLowerCase().replace("in-progress","inprogress");
  return `<span class="badge ${c}">${escapeHtml(status || "Planned")}</span>`;
}

function renderList(events){
  const tbody = $("#listTable tbody");
  if (!tbody) return;

  tbody.innerHTML = "";
  events.forEach(ev => {
    const p = ev.extendedProps;
    const tr = document.createElement("tr");
    tr.innerHTML =
      `<td>${escapeHtml(new Date(p.MS_Start).toLocaleDateString())}</td>` +
      `<td>${escapeHtml(msToHHMM(p.MS_Start))}</td>` +
      `<td>${escapeHtml(p.MS_Machine || "Montex_Stenter")}</td>` +
      `<td>${escapeHtml(p.MS_Title || "-")}</td>` +
      `<td>${escapeHtml(p.MS_Type || "-")}</td>` +
      `<td>${escapeHtml(p.MS_Technicians || "-")}</td>` +
      `<td>${badge(p.MS_Status)}</td>` +
      `<td>${escapeHtml(String(p.MS_Priority ?? ""))}</td>`;
    tr.addEventListener("click", () => showDetails({ extendedProps: p }));
    tbody.appendChild(tr);
  });

  const lc = $("#listCount");
  if (lc) lc.textContent = "Showing " + events.length + " task(s)";
}

/************ LIST MONTH LOADER ************/
function updateListTitle(d){
  const fmt = d.toLocaleString(undefined,{month:"long", year:"numeric"});
  const el = $("#listTitle");
  if (el) el.textContent = fmt;
}

function loadListMonth(baseDate){
  state.listMonth = new Date(baseDate.getFullYear(), baseDate.getMonth(), 1);
  const s = startOfMonth(state.listMonth);
  const e = endOfMonth(state.listMonth);
  state.lastListRange = { start:s, end:e };
  updateListTitle(state.listMonth);

  loading("Loading‚Ä¶");
  return readRange(s, e)
    .then(events => {
      populateFilters(events);
      state.lastEventsFull = events.slice();
      const filtered = applyFilters(events);
      renderList(filtered);
      loading("Loaded " + filtered.length + " task(s)");
    })
    .catch(err => {
      console.error(err);
      loading(err.message || "Failed to load");
    });
}

/************ VIEW SWITCH ************/
function setActiveButton(id){
  ["navCalendar","navTips","navList"].forEach(k => {
    const el = $("#" + k);
    if (el) el.classList.remove("active");
  });
  const target = $("#" + id);
  if (target) target.classList.add("active");
}

function showView(name){
  state.view = name;
  const vc = $("#viewCalendar");
  const vl = $("#viewList");
  const vt = $("#viewTips");

  if (vc) vc.style.display = (name === "calendar") ? "block" : "none";
  if (vl) vl.style.display = (name === "list") ? "block" : "none";
  if (vt) vt.style.display = (name === "tips") ? "block" : "none";

  setActiveButton(
    name === "calendar" ? "navCalendar" :
    name === "tips"     ? "navTips"     :
                          "navList"
  );

  if (name === "list"){
    if (!state.listMonth){
      const seed = state.calendar ? state.calendar.getDate() : new Date();
      loadListMonth(seed);
    } else {
      const s = startOfMonth(state.listMonth);
      const e = endOfMonth(state.listMonth);
      readRange(s,e).then(events => {
        state.lastEventsFull = events.slice();
        populateFilters(events);
        renderList(applyFilters(events));
      });
    }
  } else if (name === "calendar"){
    refreshCalendar();
  } else if (name === "tips"){
    ["#tipsPrevBody","#tipsCorrBody","#tipsMissBody","#tipsInfoBody"].forEach(sel => {
      const el = document.querySelector(sel);
      if (el) el.innerHTML = '<div class="tips-loading">Analysing the data</div>';
    });
    renderTips().catch(e => console.error(e));
  } else {
    loading("");
  }
}

/************ FILTER BUTTONS ************/
function refreshCalendar(){
  if (!state.calendar || !state.lastRange) return;
  const filtered = applyFilters(state.lastEventsFull);
  state.calendar.removeAllEvents();
  state.calendar.addEventSource(filtered);
  loading("Loaded " + filtered.length + " task(s)");
}

/************ WRITE ATTRIBUTES ************/
function writeAttributes(payload, opts){
  if (!JWT) return Promise.reject(new Error("Missing JWT (?token=)"));

  const url = API_BASE + "/plugins/telemetry/DEVICE/" + DEVICE_ID + "/SERVER_SCOPE";

  const body = {
    MS_Title: payload.MS_Title,
    MS_Machine: payload.MS_Machine,
    MS_Type: payload.MS_Type,
    MS_Priority: payload.MS_Priority,
    MS_Date: payload.MS_Date,
    MS_Start: payload.MS_Start,
    MS_End: payload.MS_End,
    MS_Status: payload.MS_Status || "Planned",
    MS_Description: payload.MS_Description || "",
    MS_Technicians: payload.MS_Technicians || "",
    MS_Task: payload.MS_Task || ""
  };

  if (opts && opts.mode === "create"){
    body[ATTR_MS_SAVE] = true;
  } else if (opts && (opts.mode === "update" || opts.mode === "cancel")){
    body[ATTR_MS_UPDATE] = true;
    if (payload[ATTR_MS_UPD_TS]) body[ATTR_MS_UPD_TS] = payload[ATTR_MS_UPD_TS];
  }

  return fetch(url, {
    method:"POST",
    headers:{
      "X-Authorization":"Bearer " + JWT,
      "Content-Type":"application/json"
    },
    body: JSON.stringify(body)
  }).then(res => res.ok ? null : res.text().then(t => { throw new Error("Attribute write failed: " + t); }));
}

/************ DETAILS PANEL ************/
function showDetails(ev){
  state.selectedEvent = ev;
  const p = ev.extendedProps;
  const fmt = v => v ? new Date(Number(v)).toLocaleString() : "-";
  const det = $("#details");
  if (!det) return;

  det.className = "";
  det.innerHTML =
    '<div class="kpi">' +
      '<span>Base ts</span><span>' + escapeHtml(String(p.__ts || "-")) + '</span>' +
      '<span>Title</span><span>' + escapeHtml(p.MS_Title || "-") + '</span>' +
      '<span>Machine</span><span>' + escapeHtml(p.MS_Machine || "Montex_Stenter") + '</span>' +
      '<span>Type</span><span>' + escapeHtml(p.MS_Type || "-") + '</span>' +
      '<span>Priority</span><span>' + escapeHtml(String(p.MS_Priority ?? "")) + '</span>' +
      '<span>Status</span><span>' + escapeHtml(p.MS_Status || "Planned") + '</span>' +
      '<span>Technicians</span><span>' + escapeHtml(p.MS_Technicians || "-") + '</span>' +
      '<span>Start</span><span>' + fmt(p.MS_Start) + '</span>' +
      '<span>End</span><span>' + fmt(p.MS_End) + '</span>' +
      '<span>Tasks</span><span>' + escapeHtml(p.MS_Task || "-") + '</span>' +
      '<span>Description</span><span>' + escapeHtml(p.MS_Description || "-") + '</span>' +
    '</div>';

  const sa = $("#sideActions");
  if (sa) sa.style.display = "flex";
}

/************ MODAL + CHIPS ************/
function busy(on){
  ["saveTask","btnCancel","btnEdit","btnNew","btnPDF"].forEach(id => {
    const el = $("#" + id);
    if (el) el.disabled = !!on;
  });
}

/* Technicians */
function refreshTechChips(){
  const box = $("#techChips");
  if (!box) return;
  box.innerHTML = "";
  state.technicians.forEach((name, idx) => {
    const chip = document.createElement("span");
    chip.className = "chip";
    chip.innerHTML = `<span>${escapeHtml(name)}</span><button type="button" aria-label="Remove">‚úï</button>`;
    chip.querySelector("button").addEventListener("click", () => {
      state.technicians.splice(idx,1);
      refreshTechChips();
    });
    box.appendChild(chip);
  });
}

function addOneTech(){
  const inp = $("#techOne");
  if (!inp) return;
  const v = (inp.value || "").trim();
  if (!v) return;
  if (state.technicians.includes(v)){
    alert("Already added: " + v);
    return;
  }
  state.technicians.push(v);
  inp.value = "";
  refreshTechChips();
}

/* Checklist items */
function refreshTaskChips(){
  const box = $("#taskChips");
  if (!box) return;
  box.innerHTML = "";
  state.taskItems.forEach((text, idx) => {
    const chip = document.createElement("span");
    chip.className = "chip";
    chip.innerHTML = `<span>${escapeHtml(text)}</span><button type="button" aria-label="Remove">‚úï</button>`;
    chip.querySelector("button").addEventListener("click", () => {
      state.taskItems.splice(idx,1);
      refreshTaskChips();
    });
    box.appendChild(chip);
  });
}

function addOneTask(){
  const inp = $("#taskOne");
  if (!inp) return;
  const v = (inp.value || "").trim();
  if (!v) return;
  state.taskItems.push(v);
  inp.value = "";
  refreshTaskChips();
}

function closeOverlay(){
  if (!overlay) overlay = $("#overlay");
  if (overlay){
    overlay.style.display = "none";
    document.body.style.overflow = "";
  }
}

/************ CREATE / UPDATE ************/
function openModalForDate(jsDate){
  state.mode = "create";
  state.pickedDate = new Date(jsDate.getFullYear(), jsDate.getMonth(), jsDate.getDate());
  $("#modalTitle").textContent = "Add maintenance task";
  $("#saveTask").textContent   = "Save";

  $("#fTitle").value = "";
  if ($("#msMachine")) $("#msMachine").value = "Montex_Stenter";
  $("#fType").value      = "Preventive";
  $("#fPriority").value  = "3";
  $("#fDate").value      = new Date(state.pickedDate.getTime() - state.pickedDate.getTimezoneOffset()*60000).toISOString().slice(0,10);
  $("#fTimeStart").value = "09:00";
  $("#fTimeEnd").value   = "11:00";

  state.technicians = [];
  refreshTechChips();
  if ($("#techOne")) $("#techOne").value = "";

  $("#fStatus").value = "Planned";
  $("#fDesc").value   = "";

  state.taskItems = [];
  refreshTaskChips();
  if ($("#taskOne")) $("#taskOne").value = "";

  if (!overlay) overlay = $("#overlay");
  if (overlay){
    overlay.style.display = "flex";
    document.body.style.overflow = "hidden";
  }
}

function collectPayload(){
  const dateStr = $("#fDate").value;
  const parts   = dateStr ? dateStr.split("-").map(Number) : null;
  const base    = parts ? new Date(parts[0], parts[1]-1, parts[2]) : (state.pickedDate || new Date());

  return {
    MS_Title: ($("#fTitle").value || "").trim(),
    MS_Machine: ($("#msMachine") && $("#msMachine").value) ? $("#msMachine").value : "Montex_Stenter",
    MS_Type: $("#fType").value || "Preventive",
    MS_Priority: parseInt($("#fPriority").value, 10) || 3,
    MS_Date: new Date(base.getFullYear(), base.getMonth(), base.getDate()).getTime(),
    MS_Start: hhmmToMs(base, $("#fTimeStart").value),
    MS_End:   hhmmToMs(base, $("#fTimeEnd").value),
    MS_Status: $("#fStatus").value || "Planned",
    MS_Description: ($("#fDesc").value || "").trim(),
    MS_Technicians: state.technicians.join(", "),
    MS_Task: state.taskItems.join(", ")
  };
}

function validatePayload(p){
  const must = [
    ["Title", p.MS_Title],
    ["Machine", p.MS_Machine],
    ["At least one technician", p.MS_Technicians]
  ];
  for (let i=0; i<must.length; i++){
    if (!must[i][1]) return "Please enter " + must[i][0];
  }
  if (p.MS_End <= p.MS_Start) return "End time must be after Start time.";
  return "";
}

/* Match event to payload */
function eventMatchesPayload(ev, payload){
  const p = ev.extendedProps || {};

  // identity match: same machine + same start + same end
  const baseMatch =
    normMachine(p.MS_Machine) === normMachine(payload.MS_Machine) &&
    Number(p.MS_Start) === Number(payload.MS_Start) &&
    Number(p.MS_End)   === Number(payload.MS_End);

  // if telemetry has __ts and payload had same __ts ‚Üí also match
  const tsMatch =
    (p.__ts && payload.__ts && String(p.__ts) === String(payload.__ts));

  return baseMatch || tsMatch;
}


/* ---------- CREATE FLOW ---------- */
function onCreate(){
  const payload = collectPayload();
  const err = validatePayload(payload);
  if (err){
    alert(err);
    return;
  }

  loading("Saving‚Ä¶");
  busy(true);

  writeAttributes(payload, { mode:"create" })
    .then(() => {
      closeOverlay();
      // Auto-refresh loop for create
      stopAutoRefresh();
      _autoDeadline = Date.now() + 3*60*1000;   // 3 minutes
      _autoTimer = setInterval(() => {
        if (Date.now() > _autoDeadline){
          stopAutoRefresh();
          loading("Stopped: timeout waiting for telemetry update");
          return;
        }
        if (!state.lastRange) return;

        readRange(state.lastRange.start, state.lastRange.end)
          .then(events => {
            state.lastEventsFull = events.slice();
            populateFilters(events);
            if (state.view === "list" && state.lastListRange){
              renderList(applyFilters(events));
            } else {
              refreshCalendar();
              const d = $("#details");
              const sa = $("#sideActions");
              if (d){ d.className = "empty"; d.textContent = "Select a task"; }
              if (sa) sa.style.display = "none";
            }
            if (events.some(ev => eventMatchesPayload(ev, payload))){
              stopAutoRefresh();
              loading("Update detected ‚úì");
            }
          })
          .catch(err => {
            console.error(err);
            loading("Auto-refresh error: " + (err.message || err));
          });
      }, 5000);
    })
    .catch(e => {
      console.error(e);
      alert(e.message || "Failed to save");
    })
    .finally(() => {
      busy(false);
    });
}

/* ---------- UPDATE FLOW ---------- */
function onUpdate() {

  if (!state.selectedEvent || !state.selectedEvent.extendedProps) {
    alert("Select a task first.");
    return;
  }

  // Collect updated form data
  const payload = collectPayload();

  // CRITICAL ‚Üí attach the correct event timestamp
  // This ensures the correct event gets updated.
  payload[ATTR_MS_UPD_TS] = state.selectedEvent.extendedProps.__ts;

  loading("Updating...");
  busy(true);

  // Write update attributes (MS_Update_Button = true)
  writeAttributes(payload, { mode: "update" })
    .then(() => {
      closeOverlay();

      // Start 65-second auto-refresh
      let remaining = 65;
      loading(`Updating‚Ä¶ (${remaining}s left)`);

      const timer = setInterval(() => {
        remaining--;
        loading(`Updating‚Ä¶ (${remaining}s left)`);

        // STOP after 65 seconds
        if (remaining <= 0) {
          clearInterval(timer);
          busy(false);
          loading("Stopped auto-refresh");
          return;
        }

        // REFRESH CALENDAR ON EVERY LOOP
        if (!state.lastRange) return;

        readRange(state.lastRange.start, state.lastRange.end)
          .then(events => {
            state.lastEventsFull = events.slice();
            populateFilters(events);
            refreshCalendar();
          })
          .catch(err => {
            console.error("Auto-refresh error:", err);
          });

      }, 3000); // Refresh every 3 seconds
    })
    .catch(err => {
      console.error(err);
      alert(err.message || "Failed to update");
    })
    .finally(() => {
      busy(false);
    });
}




/************ CANCEL ************/
function onCancel(){
  if (!state.selectedEvent || !state.selectedEvent.extendedProps){
    alert("Select a task first.");
    return;
  }
  if (!confirm("Cancel this maintenance task?")) return;

  const p = state.selectedEvent.extendedProps;
  const payload = {
    MS_Title: p.MS_Title || "",
    MS_Machine: p.MS_Machine || "Montex_Stenter",
    MS_Type: p.MS_Type || "Preventive",
    MS_Priority: p.MS_Priority != null ? p.MS_Priority : 3,
    MS_Date: p.MS_Date || null,
    MS_Start: p.MS_Start,
    MS_End: p.MS_End,
    MS_Status: "Cancelled",
    MS_Description: p.MS_Description || "",
    MS_Technicians: p.MS_Technicians || "",
    MS_Task: p.MS_Task || ""
  };
  payload[ATTR_MS_UPD_TS] = p.__ts;

  loading("Cancelling‚Ä¶");
  busy(true);

  writeAttributes(payload, { mode:"cancel" })
    .then(() => {
      // Generic auto-refresh
      stopAutoRefresh();
      _autoDeadline = Date.now() + 3*60*1000;
      _autoTimer = setInterval(() => {
        if (Date.now() > _autoDeadline){
          stopAutoRefresh();
          loading("Stopped: timeout waiting for telemetry update");
          return;
        }
        if (!state.lastRange) return;

        readRange(state.lastRange.start, state.lastRange.end)
          .then(events => {
            state.lastEventsFull = events.slice();
            populateFilters(events);

            if (state.view === "list" && state.lastListRange){
              renderList(applyFilters(events));
            } else {
              refreshCalendar();
              const d = $("#details");
              const sa = $("#sideActions");
              if (d){ d.className = "empty"; d.textContent = "Select a task"; }
              if (sa) sa.style.display = "none";
            }

            const found = events.find(ev => String(ev.extendedProps.__ts) === String(payload[ATTR_MS_UPD_TS]));
            if (found && String(found.extendedProps.MS_Status).toLowerCase() === "cancelled"){
              stopAutoRefresh();
              loading("Update detected ‚úì");
            }
          })
          .catch(err => {
            console.error(err);
            loading("Auto-refresh error: " + (err.message || err));
          });
      }, 5000);
    })
    .catch(err => {
      console.error(err);
      alert(err.message || "Failed to cancel");
    })
    .finally(() => {
      busy(false);
    });
}

/************ PDF ************/
function generatePdf(ev){
  const p = ev.extendedProps;
  const idTs = String(p.__ts || ev.start?.getTime() || Date.now());
  const reportNo = idTs;
  const genOn = new Date().toLocaleString();
  const schDate = p.MS_Date ? new Date(Number(p.MS_Date)) : new Date(p.MS_Start);
  const durMin = Math.max(0, Math.round((Number(p.MS_End) - Number(p.MS_Start))/60000));
  const durHr  = Math.floor(durMin/60);
  const remMin = durMin % 60;
  const durationText = (durHr ? durHr + "h " : "") + remMin + "m";
  const tasks = String(p.MS_Task || "").split(",").map(s => s.trim()).filter(Boolean);

  const root = document.createElement("div");
  root.className = "r-wrap";
  root.innerHTML = `
    <div class="r-head">
      <div class="logos"><img src="./PlantwizLogo.png" onerror="this.style.display='none'"></div>
      <div class="r-title">
        <h1>Pima Controls Pvt. Ltd</h1>
        <div class="addr">Block No.298, Nr. Bacha Motors, Sanathal Cross Road, Ahmedabad (382210)</div>
      </div>
      <div class="logos"><img src="./PimaLogo.png" onerror="this.style.display='none'"></div>
    </div>

    <div style="display:flex;justify-content:space-between;margin:-6px 0 8px 0;font-size:11px;color:#374151;">
      <div></div>
      <div class="r-meta">
        <div><strong>Report No:</strong> ${escapeHtml(reportNo)}</div>
        <div><strong>Generated:</strong> ${escapeHtml(genOn)}</div>
      </div>
    </div>

    <div class="r-section">
      <div class="r-sec-h">Maintenance Task Report</div>
      <div class="r-grid">
        <div class="r-card">
          <table class="r-table" style="border:0;">
            <tr><td style="border:0;padding:2px 0;"><strong>Title</strong></td><td style="border:0;padding:2px 0;">${escapeHtml(p.MS_Title || "-")}</td></tr>
            <tr><td style="border:0;padding:2px 0;"><strong>Machine / Asset</strong></td><td style="border:0;padding:2px 0;">${escapeHtml(p.MS_Machine || "Montex_Stenter")}</td></tr>
            <tr><td style="border:0;padding:2px 0;"><strong>Type</strong></td><td style="border:0;padding:2px 0;">${escapeHtml(p.MS_Type || "-")}</td></tr>
            <tr><td style="border:0;padding:2px 0;"><strong>Priority</strong></td><td style="border:0;padding:2px 0;">${escapeHtml(String(p.MS_Priority ?? "-"))}</td></tr>
            <tr><td style="border:0;padding:2px 0;"><strong>Status</strong></td><td style="border:0;padding:2px 0;">${escapeHtml(p.MS_Status || "-")}</td></tr>
          </table>
        </div>
        <div class="r-card">
          <table class="r-table" style="border:0;">
            <tr><td style="border:0;padding:2px 0;"><strong>Scheduled Date</strong></td><td style="border:0;padding:2px 0;">${schDate.toLocaleDateString()}</td></tr>
            <tr><td style="border:0;padding:2px 0;"><strong>Start</strong></td><td style="border:0;padding:2px 0;">${msToHHMM(p.MS_Start)}</td></tr>
            <tr><td style="border:0;padding:2px 0;"><strong>End</strong></td><td style="border:0;padding:2px 0;">${msToHHMM(p.MS_End)}</td></tr>
            <tr><td style="border:0;padding:2px 0;"><strong>Duration</strong></td><td style="border:0;padding:2px 0;">${durationText}</td></tr>
          </table>
        </div>
        <div class="r-card">
          <table class="r-table" style="border:0;">
            <tr><td style="border:0;padding:2px 0;"><strong>Technicians</strong></td><td style="border:0;padding:2px 0;">${escapeHtml(p.MS_Technicians || "-")}</td></tr>
            <tr><td style="border:0;padding:2px 0;"><strong>Report ID TS</strong></td><td style="border:0;padding:2px 0;">${escapeHtml(reportNo)}</td></tr>
          </table>
        </div>
      </div>
    </div>

    <div class="r-section">
      <div class="r-sec-h">Description / Notes</div>
      <div class="r-row">
        <div class="box" style="grid-column:1/-1;">${escapeHtml(p.MS_Description || "-")}</div>
      </div>
    </div>

    <div class="r-section">
      <div class="r-sec-h">Checklist</div>
      <div style="padding:10px;">
        <table class="r-table">
          <thead>
            <tr>
              <th style="width:32px;">#</th>
              <th>Task Item</th>
              <th style="width:56px;">Done</th>
              <th>Remarks</th>
              <th style="width:120px;">Checked By</th>
              <th style="width:96px;">Time</th>
            </tr>
          </thead>
          <tbody>
            ${(tasks.length ? tasks : ["‚Äî"]).map((t,i) => `
              <tr>
                <td>${i+1}</td>
                <td>${escapeHtml(String(t))}</td>
                <td>‚òê</td>
                <td></td>
                <td></td>
                <td></td>
              </tr>`).join("")}
          </tbody>
        </table>
      </div>
    </div>

    <div class="r-section">
      <div class="r-sec-h">Approvals</div>
      <div class="r-foot">
        <div class="sign"><strong>Technician Sign & Date</strong></div>
        <div class="sign"><strong>Supervisor Sign & Date</strong></div>
      </div>
    </div>

    <div class="r-fine">
      <span>Generated by Maintenance Scheduler</span>
      <span>Page 1 / 1</span>
    </div>
  `;

  const pdfRoot = $("#pdfRoot");
  if (!pdfRoot) return;
  pdfRoot.innerHTML = "";
  pdfRoot.appendChild(root);

  const opt = {
    margin:       [10,10,10,10],
    filename:     (p.MS_Title ? p.MS_Title.replace(/\s+/g,'_') : 'Maintenance_Task') + "_" + reportNo + ".pdf",
    image:        { type: 'jpeg', quality: 0.95 },
    html2canvas:  { scale: 2, useCORS: true, background: '#ffffff' },
    jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
    pagebreak:    { mode: ['css','legacy'] }
  };

  html2pdf().from(root).set(opt).save();
}

/************ RUNTIME HELPERS (for tips) ************/
function fetchDailyRuntimeMinutesForKey(dayDate, key){
  const s = startOfDay(dayDate).getTime();
  const e = endOfDay(dayDate).getTime();

  const base = API_BASE + "/plugins/telemetry/DEVICE/" + DEVICE_ID + "/values/timeseries" +
    "?keys=" + encodeURIComponent(key) +
    "&startTs=" + s +
    "&endTs="   + e;

  const fast = base + "&limit=1&orderBy=DESC";

  return fetch(fast, { headers:{ "X-Authorization":"Bearer " + JWT }})
    .then(res => res.ok ? res.json() : Promise.reject(new Error("fast runtime read failed")))
    .then(obj => {
      const arr = (obj && obj[key]) || [];
      if (arr.length) return Number(arr[0].value) || 0;
      throw new Error("empty day");
    })
    .catch(() => {
      const wide = base + "&limit=5000";
      return fetch(wide, { headers:{ "X-Authorization":"Bearer " + JWT }})
        .then(res => res.ok ? res.json() : res.text().then(t => { throw new Error("runtime read failed: " + t); }))
        .then(obj => {
          const arr = (obj && obj[key]) || [];
          if (!arr.length) return 0;
          let last = arr[0];
          for (const p of arr){
            if (Number(p.ts) > Number(last.ts)) last = p;
          }
          return Number(last.value) || 0;
        });
    });
}

async function fetchRuntimeMinutesForMachine(mNorm, fromTs, endTs){
  if (normMachine(mNorm) !== "MONTEX_STENTER") return 0;
  const key = "Currentday_Runtime";

  const start = new Date(fromTs || Date.now());
  start.setHours(0,0,0,0);
  const endDay = new Date(endTs || Date.now());
  endDay.setHours(0,0,0,0);

  let total = 0;
  for (let d = new Date(start); d <= endDay; d = new Date(d.getFullYear(), d.getMonth(), d.getDate()+1)){
    try {
      total += await fetchDailyRuntimeMinutesForKey(d, key);
    } catch(e){
      console.warn("Runtime fetch failed", e);
    }
  }
  return total;
}

/************ TIPS ENGINE ************/
function latestCompletedTsForMachine(events, mNorm){
  let latest = null;
  for (const ev of events){
    const p = ev.extendedProps || {};
    if (normMachine(p.MS_Machine) !== normMachine(mNorm)) continue;
    const st = String(p.MS_Status || "").toLowerCase();
    if (st !== "completed") continue;
    if (latest == null || Number(p.MS_End) > latest){
      latest = Number(p.MS_End);
    }
  }
  return latest;
}

async function tipsPreventiveCoverage(monthStartDate){
  const s = new Date(monthStartDate.getFullYear(), monthStartDate.getMonth(), 1);
  const e = new Date(monthStartDate.getFullYear(), monthStartDate.getMonth()+1, 0, 23,59,59,999);

  let events;
  try {
    events = await readRange(s,e);
  } catch(err){
    console.error("Coverage fetch failed", err);
    throw err;
  }

  const byMachine = new Map();
  const scheduled = new Set(["planned","in-progress","completed","postponed"]);

  for (const ev of events){
    const p = ev.extendedProps || {};
    const mNorm = normMachine(p.MS_Machine);
    if (!mNorm) continue;

    const st = String(p.MS_Status || "").trim().toLowerCase().replace("inprogress","in-progress");
    if (!scheduled.has(st)) continue;

    if (!byMachine.has(mNorm)) byMachine.set(mNorm, { pretty: p.MS_Machine, count: 0 });
    const entry = byMachine.get(mNorm);
    entry.count++;
    entry.pretty = p.MS_Machine || entry.pretty;
  }

  const MIN_WINDOWS = 2;
  const cards = [];

  for (const [, info] of byMachine){
    if (info.count < MIN_WINDOWS){
      cards.push({
        severity: info.count === 0 ? "High" : "Medium",
        title: `Low maintenance coverage ‚Äî ${info.pretty}`,
        subtitle: `This month maintenance windows (all types): ${info.count} (min: ${MIN_WINDOWS})`,
        body: `We treat any maintenance visit as an opportunity to run full checks. ${info.pretty} has only ${info.count || 0} this month.\nTip: add/merge another window if feasible.`,
        cta: { label: "Schedule", action: () => openModalForDate(new Date()) }
      });
    }
  }
  return cards;
}

async function tipsPreventiveRuntime(){
  const lookBackStart = new Date();
  lookBackStart.setDate(lookBackStart.getDate() - 120);

  const events = await readRange(lookBackStart, new Date());

  const mNorm = "Montex_Stenter";
  const lastCompletedTs = latestCompletedTsForMachine(events, mNorm) || lookBackStart.getTime();

  const totalMinutes = await fetchRuntimeMinutesForMachine(mNorm, lastCompletedTs);
  const totalHours = totalMinutes / 60.0;

  const pretty = "Montex_Stenter";
  const statusTxt = totalHours > 400 ? "Above 400 hrs (Action required)" : "Below 400 hrs";

  return [{
    severity: totalHours > 400 ? "High" : "Info",
    title: `Runtime monitor ‚Äî ${pretty}`,
    subtitle: `Runtime since last maintenance: ${totalHours.toFixed(1)} hrs`,
    body: `Machine ${pretty} has run ${totalHours.toFixed(1)} hrs since last maintenance.\nStatus: ${statusTxt}.`,
    note: `Measured from last completed maintenance;`,
    cta: { label: "Schedule", action: () => openModalForDate(new Date()) }
  }];
}

async function tipsCorrectiveTelemetry(){
  try {
    const { start, end, downtimeArr, runtimeArr } = await readDowntimeAndRuntime();

    const totalDowntimeMinutes = downtimeArr.filter(p => Number(p.value) === 1).length;

    let occurrences = 0;
    for (let i=1; i<downtimeArr.length; i++){
      const prev = Number(downtimeArr[i-1].value);
      const curr = Number(downtimeArr[i].value);
      if (prev === 0 && curr === 1) occurrences++;
    }

    const totalRuntimeMinutes = runtimeArr.filter(p => Number(p.value) === 1).length;
    const totalRuntimeHours = totalRuntimeMinutes / 60;

    const MTTF = occurrences > 0 ? (totalRuntimeHours / occurrences) : 0;
    const MTTR = occurrences > 0 ? (totalDowntimeMinutes / occurrences) : 0;

    return [{
      severity: (totalDowntimeMinutes > 250 || occurrences > 5) ? "High" : "Medium",
      title: "Corrective Maintenance ‚Äî Montex_Stenter",
      subtitle: `Window: ${start.toLocaleDateString()} ‚Üí ${end.toLocaleDateString()}`,
      body:
        `‚Ä¢ Total Downtime: ${totalDowntimeMinutes} minutes\n` +
        `‚Ä¢ Downtime Occurrences: ${occurrences}\n` +
        `‚Ä¢ Runtime: ${totalRuntimeHours.toFixed(1)} hours\n\n` +
        `‚Ä¢ MTTF: ${MTTF.toFixed(1)} hours\n` +
        `‚Ä¢ MTTR: ${MTTR.toFixed(1)} minutes\n`,
      cta: { label: "Create Task", action: () => openModalForDate(new Date()) }
    }];
  } catch(err){
    console.error(err);
    return [{
      severity: "Info",
      title: "Corrective data unavailable",
      body: "Unable to read Downtime or Runtime telemetry."
    }];
  }
}

async function tipsMissed(){
  const lookBackStart = new Date();
  lookBackStart.setDate(lookBackStart.getDate() - 60);
  const now = new Date();

  const events = await readRange(lookBackStart, now);
  const missed = [];

  for (const ev of events){
    const p = ev.extendedProps || {};
    const st = String(p.MS_Status || "").toLowerCase();
    const isOpen = (st === "planned" || st === "in-progress" || st === "inprogress");
    if (!isOpen) continue;

    if (Number(p.MS_Start) < Date.now()){
      missed.push({
        severity: "High",
        title: `Overdue: ${p.MS_Title || "Maintenance"} ‚Äî ${p.MS_Machine || "Montex_Stenter"}`,
        subtitle: `Scheduled for ${new Date(Number(p.MS_Start) || Date.now()).toLocaleString()}`,
        body: `This task is overdue. Update status or reschedule.`,
        cta: { label: "Reschedule", action: () => openModalForDate(new Date()) }
      });
    }
  }
  return missed;
}

/* Tips rendering helpers */
function tipCardHTML(t){
  const sevChip = t.severity ? `<span class="chip-note">${escapeHtml(t.severity)}</span>` : "";
  const note = t.note ? `<div class="muted" style="margin-top:6px;font-size:12px">${escapeHtml(t.note)}</div>` : "";
  return `
    <div class="tip-card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
        <div class="tip-title">${escapeHtml(t.title)}</div>
        ${sevChip}
      </div>
      ${ t.subtitle ? `<div class="muted" style="font-size:12px;margin:2px 0 8px;white-space:pre-line">${escapeHtml(t.subtitle)}</div>` : "" }
      <div class="tip-body">${escapeHtml(t.body || "")}</div>
      ${note}
      <div class="tip-actions">
        ${ t.cta ? `<button class="btn" type="button">${escapeHtml(t.cta.label)}</button>` : "" }
      </div>
    </div>
  `;
}

async function renderTips(){
  loading("Analysing tips‚Ä¶");
  const now = new Date();
  const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);

  try {
    const [coverageCards, correctiveCards, missedCards, runtimeCards] = await Promise.all([
      tipsPreventiveCoverage(monthStart),
      tipsCorrectiveTelemetry(),
      tipsMissed(),
      tipsPreventiveRuntime()
    ]);

    const prevBody = $("#tipsPrevBody");
    const prevCards = coverageCards || [];
    if (prevBody){
      prevBody.innerHTML = prevCards.length
        ? prevCards.map(t => tipCardHTML(t)).join("")
        : `<div class="tip-empty">No maintenance coverage suggestions.</div>`;
      prevBody.querySelectorAll(".tip-card .btn").forEach(btn =>
        btn.addEventListener("click", () => openModalForDate(new Date()))
      );
    }
    const prevCount = $("#tipsPrevCount");
    if (prevCount) prevCount.textContent = prevCards.length ? `(${prevCards.length})` : "";

    const corrBody = $("#tipsCorrBody");
    const corrCards = correctiveCards || [];
    if (corrBody){
      corrBody.innerHTML = corrCards.length
        ? corrCards.map(t => tipCardHTML(t)).join("")
        : `<div class="tip-empty">No corrective suggestions.</div>`;
      corrBody.querySelectorAll(".tip-card .btn").forEach(btn =>
        btn.addEventListener("click", () => openModalForDate(new Date()))
      );
    }
    const corrCount = $("#tipsCorrCount");
    if (corrCount) corrCount.textContent = corrCards.length ? `(${corrCards.length})` : "";

    const missBody = $("#tipsMissBody");
    const miss = missedCards || [];
    if (missBody){
      missBody.innerHTML = miss.length
        ? miss.map(t => tipCardHTML(t)).join("")
        : `<div class="tip-empty">No missed items detected.</div>`;
      missBody.querySelectorAll(".tip-card .btn").forEach(btn =>
        btn.addEventListener("click", () => openModalForDate(new Date()))
      );
    }
    const missCount = $("#tipsMissCount");
    if (missCount) missCount.textContent = miss.length ? `(${miss.length})` : "";

    const infoBody = $("#tipsInfoBody");
    const infoCards = runtimeCards || [];
    if (infoBody){
      infoBody.innerHTML = infoCards.length
        ? infoCards.map(t => tipCardHTML(t)).join("")
        : `<div class="tip-empty">No additional info.</div>`;
      infoBody.querySelectorAll(".tip-card .btn").forEach(btn =>
        btn.addEventListener("click", () => openModalForDate(new Date()))
      );
    }
    const infoCount = $("#tipsInfoCount");
    if (infoCount) infoCount.textContent = infoCards.length ? `(${infoCards.length})` : "";

    loading("Tips ready");
  } catch(e){
    console.error(e);
    if ($("#tipsPrevBody")) $("#tipsPrevBody").innerHTML = `<div class="tip-empty">Failed to generate tips.</div>`;
    if ($("#tipsCorrBody")) $("#tipsCorrBody").innerHTML = `<div class="tip-empty">‚Äî</div>`;
    if ($("#tipsMissBody")) $("#tipsMissBody").innerHTML = `<div class="tip-empty">‚Äî</div>`;
    if ($("#tipsInfoBody")) $("#tipsInfoBody").innerHTML = `<div class="tip-empty">‚Äî</div>`;
    loading("Tips error");
  }
}

/************ CALENDAR BOOT ************/
function startCalendar(){
  const calEl = $("#calendar");
  if (!calEl){
    console.error("Calendar element #calendar not found");
    return;
  }
  if (!window.FullCalendar){
    calEl.innerHTML = '<div class="empty"><span class="err">FullCalendar failed to load.</span></div>';
    return;
  }
  if (!JWT){
    calEl.innerHTML = '<div class="empty"><span class="err">Missing JWT (?token=‚Ä¶)</span></div>';
    return;
  }

  state.calendar = new FullCalendar.Calendar(calEl, {
    initialView: "dayGridMonth",
    headerToolbar: { left:"prev,next today", center:"title", right:"" },
    height: "auto",
    eventContent: eventContent,
    dateClick: info => openModalForDate(info.date),
    eventClick: info => showDetails(info.event),
    datesSet: info => {
      state.lastRange = { start: info.start, end: info.end };
      readRange(info.start, info.end)
        .then(events => {
          state.lastEventsFull = events.slice();
          populateFilters(events);
          if (state.view === "calendar"){
            refreshCalendar();
            const d = $("#details");
            const sa = $("#sideActions");
            if (d){ d.className = "empty"; d.textContent = "Select a task"; }
            if (sa) sa.style.display = "none";
          }
        })
        .catch(err => {
          console.error(err);
          loading(err.message || "Failed to load");
          if (state.calendar) state.calendar.removeAllEvents();
        });
    }
  });

  state.calendar.render();

  const toolbar = calEl.querySelector(".fc-toolbar-chunk:nth-child(3)");
  if (toolbar){
    const legends = document.createElement("div");
    legends.className = "fc-toolbar-chunk legends";
    legends.innerHTML = `
      <span><span class="legend-box legend-planned"></span> Planned</span>
      <span><span class="legend-box legend-inprogress"></span> In-Progress</span>
      <span><span class="legend-box legend-completed"></span> Completed</span>
      <span><span class="legend-box legend-cancelled"></span> Cancelled</span>
      <span><span class="legend-box legend-postponed"></span> Postponed</span>
    `;
    toolbar.appendChild(legends);
  }
}

/************ INIT LISTENERS ************/
function initUI(){
  overlay = $("#overlay");

  const navCal  = $("#navCalendar");
  const navTips = $("#navTips");
  const navList = $("#navList");
  if (navCal)  navCal.addEventListener("click", () => showView("calendar"));
  if (navTips) navTips.addEventListener("click", () => showView("tips"));
  if (navList) navList.addEventListener("click", () => showView("list"));

  const btnPrev  = $("#listPrev");
  const btnNext  = $("#listNext");
  const btnToday = $("#listToday");
  if (btnPrev)  btnPrev.addEventListener("click", () => {
    const d = state.listMonth ? new Date(state.listMonth) : new Date();
    d.setMonth(d.getMonth() - 1);
    loadListMonth(d);
  });
  if (btnNext)  btnNext.addEventListener("click", () => {
    const d = state.listMonth ? new Date(state.listMonth) : new Date();
    d.setMonth(d.getMonth() + 1);
    loadListMonth(d);
  });
  if (btnToday) btnToday.addEventListener("click", () => loadListMonth(new Date()));

  const btnApply = $("#btnApplyFilters");
  const btnReset = $("#btnResetFilters");
  if (btnApply) btnApply.addEventListener("click", () => {
    if (state.view === "list"){
      if (state.listMonth) loadListMonth(state.listMonth);
    } else if (state.view === "tips"){
      showView("tips");
    } else {
      refreshCalendar();
    }
  });
  if (btnReset) btnReset.addEventListener("click", () => {
    const fm = $("#filtMa");
    const ft = $("#filtTy");
    const fs = $("#filtSt");
    if (fm) fm.value = "__ALL__";
    if (ft) ft.value = "__ALL__";
    if (fs) fs.value = "__ALL__";
    state.filters = { ma:"__ALL__", ty:"__ALL__", st:"__ALL__" };
    if (state.view === "list"){
      if (state.listMonth) loadListMonth(state.listMonth);
    } else if (state.view === "tips"){
      showView("tips");
    } else {
      refreshCalendar();
    }
  });

  const addTechBtn = $("#addTechBtn");
  const techOne    = $("#techOne");
  if (addTechBtn) addTechBtn.addEventListener("click", addOneTech);
  if (techOne) techOne.addEventListener("keydown", e => {
    if (e.key === "Enter"){
      e.preventDefault();
      addOneTech();
    }
  });

  const addTaskBtn = $("#addTaskBtn");
  const taskOne    = $("#taskOne");
  if (addTaskBtn) addTaskBtn.addEventListener("click", addOneTask);
  if (taskOne) taskOne.addEventListener("keydown", e => {
    if (e.key === "Enter"){
      e.preventDefault();
      addOneTask();
    }
  });

  const closeModalBtn = $("#closeModal");
  if (closeModalBtn) closeModalBtn.addEventListener("click", closeOverlay);

  const btnNew = $("#btnNew");
  if (btnNew) btnNew.addEventListener("click", () => openModalForDate(new Date()));

  const saveTaskBtn = $("#saveTask");
  if (saveTaskBtn) saveTaskBtn.addEventListener("click", () => {
    if (state.mode === "update") onUpdate();
    else onCreate();
  });

  const btnEdit = $("#btnEdit");
  if (btnEdit) btnEdit.addEventListener("click", () => {
    if (!state.selectedEvent){
      alert("Select a task first.");
      return;
    }
    const p = state.selectedEvent.extendedProps;
    state.mode = "update";
    $("#modalTitle").textContent = "Update maintenance task";
    $("#saveTask").textContent   = "Update";

    const date = new Date(p.MS_Date || p.MS_Start);
    state.pickedDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());

    $("#fTitle").value = p.MS_Title || "";
    if ($("#msMachine")) $("#msMachine").value = p.MS_Machine || "Montex_Stenter";
    $("#fType").value     = p.MS_Type || "Preventive";
    $("#fPriority").value = String(p.MS_Priority != null ? p.MS_Priority : "3");
    $("#fDate").value     = new Date(state.pickedDate.getTime() - state.pickedDate.getTimezoneOffset()*60000).toISOString().slice(0,10);
    $("#fTimeStart").value= pad2(new Date(p.MS_Start).getHours()) + ":" + pad2(new Date(p.MS_Start).getMinutes());
    $("#fTimeEnd").value  = pad2(new Date(p.MS_End).getHours())   + ":" + pad2(new Date(p.MS_End).getMinutes());

    state.technicians = (p.MS_Technicians || "").split(",").map(s => s.trim()).filter(Boolean);
    refreshTechChips();
    if ($("#techOne")) $("#techOne").value = "";

    $("#fStatus").value = p.MS_Status || "Planned";
    $("#fDesc").value   = p.MS_Description || "";

    state.taskItems = (p.MS_Task || "").split(",").map(s => s.trim()).filter(Boolean);
    refreshTaskChips();
    if ($("#taskOne")) $("#taskOne").value = "";

    if (!overlay) overlay = $("#overlay");
    if (overlay){
      overlay.style.display = "flex";
      document.body.style.overflow = "hidden";
    }
  });

  const btnCancel = $("#btnCancel");
  if (btnCancel) btnCancel.addEventListener("click", onCancel);

  const btnPDF = $("#btnPDF");
  if (btnPDF) btnPDF.addEventListener("click", () => {
    if (!state.selectedEvent){
      alert("Select a task first.");
      return;
    }
    generatePdf(state.selectedEvent);
  });
}

/************ BOOT ************/
if (document.readyState === "complete" || document.readyState === "interactive"){
  setTimeout(() => {
    initUI();
    startCalendar();
  }, 0);
} else {
  document.addEventListener("DOMContentLoaded", () => {
    initUI();
    startCalendar();
  });
}

/************ CALENDAR REFRESH HELPERS (for update flow) ************/
// Force calendar reload correctly after an update
function refreshCalendarAfterUpdate(payload){
  if (!state.calendar || !state.lastRange) return Promise.resolve();

  const { start, end } = state.lastRange;

  return readRange(start, end)
    .then(events => {
      state.lastEventsFull = events.slice();
      populateFilters(events);

      const filtered = applyFilters(events);

      // remove old
      const sources = state.calendar.getEventSources();
      sources.forEach(src => src.remove());

      // add new
      state.calendar.addEventSource(filtered);
      state.calendar.refetchEvents();
    })
    .catch(err => {
      console.error("Calendar refresh error:", err);
    });
}

// Check if updated event is now visible in calendar
function calendarContainsUpdatedEvent(payload){
  return state.lastEventsFull.some(ev => eventMatchesPayload(ev, payload));
}
</script>
</body>
</html>
